#!/bin/bash

# ==============================================================================
#  –£–õ–£–ß–®–ï–ù–ù–´–ô –¢–ï–°–¢–û–í–´–ô –°–ö–†–ò–ü–¢ API v2
#  - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.
#  - –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫ –æ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö.
#  - –î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID.
# ==============================================================================

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
# –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_USER="admin_user"
ADMIN_PASS='^pu8LPn:5{[+6;:)LaW|1ck' 

# ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –û–ë–ù–û–í–õ–ï–ù–ò–ï
# –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏, –æ–Ω –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
EXISTING_USER_ID="9c81b7a3-c573-44f9-8fa0-70d052eb0657"

# --- –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---
TIMESTAMP=$(date +%s)
UNIQUE_USER="testuser_$TIMESTAMP"
UNIQUE_EMAIL="$UNIQUE_USER@example.com"
echo "‚ú® –ë—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $UNIQUE_USER"


# --- –®–∞–≥ 2: –í—Ö–æ–¥ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ---
echo -e "\nüîë –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞..."

TOKEN=$(curl -s -X POST "http://localhost:8001/admin/login" \
-H "Content-Type: application/json" \
-d "{
  \"username\": \"$ADMIN_USER\",
  \"password\": \"$ADMIN_PASS\"
}" | jq -r .token)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω
if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞."
    exit 1
fi
echo "‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω."


# --- –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –ù–û–í–û–ì–û –£–ù–ò–ö–ê–õ–¨–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
echo -e "\n‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$UNIQUE_USER'..."
NEW_USER_RESPONSE=$(curl -s -X POST "http://localhost:8001/admin/users" \
-H "Authorization: Bearer $TOKEN" \
-H "Content-Type: application/json" \
-d "{
    \"username\": \"$UNIQUE_USER\",
    \"password\": \"new_strong_password\",
    \"email\": \"$UNIQUE_EMAIL\",
    \"type_of_user\": \"dynamic_tester\"
}")

echo "$NEW_USER_RESPONSE" | jq .
NEW_USER_ID=$(echo "$NEW_USER_RESPONSE" | jq -r .id)


# --- –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª—Å—è (–ø–æ ID) ---
if [ -n "$NEW_USER_ID" ] && [ "$NEW_USER_ID" != "null" ]; then
    echo -e "\nüîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID: $NEW_USER_ID..."
    curl -s -X GET "http://localhost:8001/admin/users/$NEW_USER_ID" \
    -H "Authorization: Bearer $TOKEN" | jq .
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–ª—å–Ω–µ–π—à–∏–µ —Ç–µ—Å—Ç—ã —Å –Ω–∏–º –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è."
fi


# --- –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –î–†–£–ì–û–ì–û, –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
echo -e "\nüîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: $EXISTING_USER_ID..."
curl -s -X PUT "http://localhost:8001/admin/users/$EXISTING_USER_ID" \
-H "Authorization: Bearer $TOKEN" \
-H "Content-Type: application/json" \
-d '{
    "type_of_user": "updated_owner"
}' | jq .


# --- –®–∞–≥ 6: –£–¥–∞–ª–µ–Ω–∏–µ –°–û–ó–î–ê–ù–ù–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
if [ -n "$NEW_USER_ID" ] && [ "$NEW_USER_ID" != "null" ]; then
    echo -e "\nüóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: $NEW_USER_ID..."
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º -v –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç—É—Å-–∫–æ–¥–∞
    curl -s -o /dev/null -w "HTTP —Å—Ç–∞—Ç—É—Å: %{http_code}\n" -X DELETE "http://localhost:8001/admin/users/$NEW_USER_ID" \
    -H "Authorization: Bearer $TOKEN"
    echo "(–û–∂–∏–¥–∞–µ–º—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: 204)"
else
    echo -e "\nüóëÔ∏è –ü—Ä–æ–ø—É—Å–∫ —É–¥–∞–ª–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω."
fi


# --- –®–∞–≥ 7: –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã ---
echo -e "\nüö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (Logout)..."
curl -s -X POST "http://localhost:8001/admin/logout" \
-H "Authorization: Bearer $TOKEN" | jq .


# --- –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ ---
echo -e "\n‚ùå –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º..."
curl -s -X GET "http://localhost:8001/admin/users" \
-H "Authorization: Bearer $TOKEN" | jq .

echo -e "\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."